{% extends '_layouts/base.html' %}
{% block script %}
<script>
    avatarChanged = false;
    (function(){
        document.getElementById('photo_file').onchange = onFileChanged(this);
    })();
    function onFileChanged(){
        avatarChanged = true;
    }
    function on_submit(){
        if( avatarChanged ){
            files = document.getElementById("photo_file").files;
            filename = files[0].name;
            document.getElementById("hidden_filename").setAttribute("value", filename);
            get_signed_request(files[0]);
        }
        (document.getElementById("edit_profile_form")).submit();
    }
    function get_signed_request(file){
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "sign_s3/?file_name="+file.name+"&file_type="+file.type);
        xhr.onreadystatechange = function(){
            if(xhr.readyState === 4){
                if(xhr.status === 200){
                    var response = JSON.parse(xhr.responseText);
                    upload_file(file, response.signed_request, response.url);
                }
                else{
                    alert("Could not get signed URL.");
                }
            }
        };
        xhr.send();
    }

    function upload_file(file, signed_request, url){
        var xhr = new XMLHttpRequest();
        xhr.open("PUT", signed_request);
        xhr.setRequestHeader('x-amz-acl', 'public-read');
        xhr.onload = function() {
            if (xhr.status === 200) {
                document.getElementById("profile_photo").src = url;
                // document.getElementById("avatar_url").value = url;
            }
        };
        xhr.onerror = function() {
            alert("Could not upload file.");
        };
        xhr.send(file);
    }
</script>
{% endblock script %}
{% load crispy_forms_tags %}
{% load friendshiptags %}

{% block content %}
{% if edit %}
  <p>Changes have been made</p>
{% endif %}
    <image id='profile_photo' src="{{ MEDIA_URL }}{{ current_profile.avatar }}"></image>
{% crispy form %}
<input type="button" name="submit" value="Save Changes" class="btn btn-primary" id="submit-id-submit" onclick="on_submit()"/>
{% if current_profile %}
  <p>Active user since {{current_profile.creation_date}}</p>
{% else %}
  <p>You must be logged in to view this page.</p>
{% endif %}

{% endblock %}
